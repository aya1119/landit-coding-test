import { Injectable, OnModuleInit } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Spot } from './spot.entity';
import * as fs from 'fs';
import * as path from 'path';

@Injectable()
export class SpotService implements OnModuleInit {
  constructor(
    @InjectRepository(Spot)
    private spotRepository: Repository<Spot>,
  ) {}

  async onModuleInit() {
    const count = await this.spotRepository.count();
    if (count > 0) {
      console.log('Seed already executed');
      return;
    }

    console.log('Seeding database...');

    const filePath = path.join(process.cwd(), 'landit_coding_test_seed.csv');
    const file = fs.readFileSync(filePath, 'utf8');
    const lines = file.split('\n').slice(1);

    for (const line of lines) {
      if (!line) continue;

      const [name, category, lat, long, address] = line.split(',');

      await this.spotRepository.query(
        `
        INSERT INTO spot (name, category, address, location)
        VALUES ($1, $2, $3, ST_SetSRID(ST_MakePoint($4, $5), 4326))
        `,
        [name, category, address, parseFloat(long), parseFloat(lat)],
      );
    }

    console.log('Seeding completed');
  }
  async findNearby(lat: number, lng: number, radiusKm: number) {
    const radiusMeters = radiusKm * 1000;

    return this.spotRepository.query(
      `
      SELECT
        id,
        name,
        category,
        address,
        ST_Y(location::geometry) AS lat,
        ST_X(location::geometry) AS lng
      FROM spot
      WHERE ST_DWithin(
        location,
        ST_SetSRID(ST_MakePoint($1, $2), 4326)::geography,
        $3
      )
      ORDER BY id
      `,
      [lng, lat, radiusMeters],
    );
  }
}

